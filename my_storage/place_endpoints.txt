
## Places
@app.route('/places/get')
def get_place():
    try:
        id = request.args.get('id')

        # Exception handling
        ## Check id argument is not null
        if id is None:
            raise Exception('Id cannot be null')
        ## Check id argument is not empty
        if len(id) == 0:
            raise Exception('Id cannot be empty')
        ## Check id is an int - it throws ValueError if not 
        int(id)

        # Make query to database
        place = session.query(Place).filter(Place.id == id).first()

        # Check an place exists with the id
        if place is None:
            raise Exception('No user exists with this id')
        
        result = get_place_dict(place)

        return jsonify(result), 200
    
    except ValueError as e:
        return jsonify({'error': 'Id has to be an integer'}), 400
    except Exception as e:
        code = None
        if str(e) == 'No place exists with this id':
            code = 404
        else:
            code = 400
        return jsonify({'error': str(e)}), code

@app.route('/places/getAll')
def get_all_places():
    places = session.query(Place)

    result = []

    for row in places:
        place = get_place_dict(row)
        result.append(place)
    
    return jsonify(result), 200

def get_place_dict(data):
    return {
        'id': data.id,
        'name': data.name,
        'type': data.type,
        'price_per_night': data.price_per_night,
        'owner_id': data.owner_id
    }

'''
    id = Column(Integer, primary_key=True)
    name = Column(String)
    type = Column(Enum(PlaceCategory))
    price_per_night = Column(Float)
    
    # Relationships
    ## Owner relationship
    owner_id = Column(Integer, ForeignKey('users.id'))
'''

@app.route('/places/create', methods=['POST'])
def create_place():
    try:
        data = request.get_json()

        # A place should always have an owner
        owner_id = data.get('owner_id')

        if owner_id is None:
            raise Exception('owner_id cannot be null')
        
        response = requests.get(f'http://localhost:5000/users/get?id={owner_id}')
        if response.status_code != 200:
            raise Exception('no user with the owner_id provided exists')
        
        # Create and add place
        place = Place(
            name = data.get('name', None),
            type = data.get('type', None),
            price_per_night = data.get('price_per_night', None),
            owner_id = data.get('owner_id')
        )

        session.add(place)
        session.commit()

        return jsonify({'message': 'place created successfully'}), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 400

@app.route('/places/update', methods=['PUT'])
def update_place():
    try:
        id = request.args.get('id')

        ## Check id argument is not null
        if id is None:
            raise Exception('Id cannot be null')
        ## Check id argument is not empty
        if len(id) == 0:
            raise Exception('Id cannot be empty')
        ## Check id is an int - it throws ValueError if not 
        int(id)

        place = session.query(Place).filter(Place.id == id).first()
        if place is None:
            raise Exception('No place exists with this id')

        data = request.get_json()

        place.name = data.get('name', place.name)
        place.type = data.get('type', place.type)
        place.price_per_night = data.get('price_per_night', place.price_per_night)
        # owner_id cannot be updated

        session.commit()

        return jsonify({'message': 'place updated successfully'}), 200

    except ValueError as e:
        return jsonify({'error': 'Id has to be an integer'}), 400
    except Exception as e:
        code = None
        if str(e) == 'No place exists with this id':
            code = 404
        else:
            code = 400
        return jsonify({'error': str(e)}), code

@app.route('/places/delete', methods=['DELETE'])
def delete_place():
    try:
        id = request.args.get('id')

        # Exception handling
        ## Check id argument is not null
        if id is None:
            raise Exception('Id cannot be null')
        ## Check id argument is not empty
        if len(id) == 0:
            raise Exception('Id cannot be empty')
        ## Check id is an int - it throws ValueError if not 
        int(id)

        # Make query to database
        place = session.query(Place).filter(Place.id == id).first()

        # Check an user exists with the id
        if place is None:
            raise Exception('No place exists with this id')

        # Delete
        session.delete(place)
        session.commit()

        # Format result and send it
        return jsonify({'message': 'place deleted successfully'}), 200
        
    except ValueError as e:
        return jsonify({'error': 'Id has to be an integer'}), 400
    except Exception as e:
        code = None
        if str(e) == 'No place exists with this id':
            code = 404
        else:
            code = 400
        return jsonify({'error': str(e)}), code